{% extends "base.html" %}
{% load staticfiles %}

{% block title %}Agenda{% endblock%}

{% block social_meta %}
        <meta name="twitter:card" content="summary_large_image">
        <meta name="twitter:title" content="{{venue.name}} - Alcalá Suena: Fiesta de la Música 2017">
        <meta name="twitter:description" content="Todos los conciertos en {{venue.name}} durante Alcalá Suena: Fiesta de la Música 2017">
        <meta name="twitter:image" content="{{ request.scheme }}://{{ request.META.HTTP_HOST }}{%if venue.image %}{{venue.image.url}}{% else %}{% static "img/logo_banner.jpg" %}{% endif %}">

        <meta property="og:url" content="{{request.build_absolute_uri}}" />
        <meta property="og:type" content="article" />
        <meta property="og:title" content="{{venue.name}} - Alcalá Suena: Fiesta de la Música 2017" />
        <meta property="og:description" content="Todos los conciertos en {{venue.name}} durante Alcalá Suena: Fiesta de la Música 2017" />
        <meta property="og:image" content="{{ request.scheme }}://{{ request.META.HTTP_HOST }}{%if venue.image %}{{venue.image.url}}{% else %}{% static "img/logo_banner.jpg" %}{% endif %}" />
{% endblock %}

{% block bodyattrs %}class="event"{% endblock%}

{% block extra_styles %}
    <link rel="stylesheet" type="text/css" href="{% static "css/daterangepicker.css" %}"/>
{% endblock extra_styles %}

{% block content %}
<div class="jumbo-header minimal">
    <div class="jumbotron">
      <div class="container text-center">
            <h1>Agenda</h1>
      </div>
    </div>
</div>

<div class="container">
    <div class="row margin-top">
        <div class="col-md-3 col-lg-2 events-searchbox panel" style="margin-top:0;">
            <i class="fa fa-search panel-icon" aria-hidden="true"></i>
            <form id="event-filter" action="{% url 'events_schedule' %}">

                <div class="filter margin-top">
                    <input class="form-control" id="search" value="{{query_string}}" type="text" name="q" placeholder="Buscar...">
                </div>

                <div class="filter">
                    <div class="secondary header-bar"> <h5><i class="fa fa-share-alt right-margin" aria-hidden="true"></i> Por fecha</h5> </div>

      <div class="btn-group btn-group-vertical" data-toggle="buttons">
        <label class="btn {%if not date_filter %}active{%endif%}">
          <input type="radio" id="this_week" data-startdate={{dates.thisweek_start|date:"d/m/Y"}} name="preselect_date" data-enddate="{{dates.thisweek_end|date:"d/m/Y"}}" {%if not date_filter %}checked{%endif%}><i class="fa fa-circle-o fa-2x"></i><i class="fa fa-dot-circle-o fa-2x"></i> <span> Esta semana</span>
        </label>
        <label class="btn">
          <input type="radio" id="next_week" data-startdate={{dates.nextweek_start|date:"d/m/Y"}} name="preselect_date" data-enddate="{{dates.nextweek_end|date:"d/m/Y"}}"><i class="fa fa-circle-o fa-2x"></i><i class="fa fa-dot-circle-o fa-2x"></i><span> Próxima semana</span>
        </label>
      </div>

                    <div class="btn-group">
                    <a class="btn {%if not date_filter %}collapsed{%endif%} advancefilter" role="button" data-toggle="collapse" href="#advancedDateFilter" aria-expanded="false" aria-controls="advancedDateFilter">
  <i class="fa fa-angle-up fa-2x" aria-hidden="true"></i> Avanzado
</a>
                        </div>
                    <div class="collapse {%if date_filter %}in{%endif%}" id="advancedDateFilter">

                        <div class="input-group">
                          <input class="form-control" id="dateRange" type="text" name="date_range" placeholder="Desde - hasta...">
                          <span class="input-group-btn">
                            <button class="btn btn-default" id="dateRangeBtn" type="button"><i class="fa fa-calendar" aria-hidden="true"></i></button>
                          </span>
                        </div>


                        <input type="hidden" name="start_date" value="{{dates.start_date|date:"d/m/Y"}}">
                        <input type="hidden" name="end_date" value="{{dates.end_date|date:"d/m/Y"}}">
                    </div>
                </div>

                <div class="filter">
                    <div class="secondary header-bar"> <h5><i class="fa fa-share-alt right-margin" aria-hidden="true"></i> Por espacio</h5> </div>
                    <select class="form-control"  id="venue_select" name="venue">
                        <option value="" {% if not venue_filter %} selected {% endif %}>----</option>
                        {% for venue in venues %}
                        {% with venue.pk|slugify as venue_pk %}
                        <option value="{{venue.pk}}" {%if venue_filter == venue_pk %} selected {%endif%}>{{venue.name}}</option>
                        {% endwith %}
                        {% endfor %}
                    </select>
                </div>

                <div class="filter">
                    <div class="secondary header-bar"> <h5><i class="fa fa-share-alt right-margin" aria-hidden="true"></i> Por etiqueta</h5> </div>
                    <select class="form-control" id="tag_select" name="tag">
                        <option value="" {% if not tag_filter %} selected {% endif %}>----</option>
                        {% for tag in tags %}
                        <option value="{{venue.pk}}" {%if tag_filter == tag.pk %} selected {%endif%}>{{tag.name}}</option>
                        {% endfor %}
                    </select>
                </div>

                <input type="submit" id="searchButton" class="btn btn-large btn-primary" value="Buscar">
            </form>
        </div>

        <div class="col-md-9 col-lg-10" id="search_results">
            <div class="results">
                {% include 'event/search_results.html' with events=events %}
            </div>
            <i class="fa fa-circle-o-notch fa-spin fa-3x fa-fw loading-spinner"></i>
            <span class="sr-only">Loading...</span>
        </div>
    </div>

</div>

{% endblock %}

{% block scripts %}
<script type="text/javascript" src="{% static "js/moment.min.js" %}"></script>
<script type="text/javascript" src="{% static "js/daterangepicker.js" %}"></script>
<script type="text/javascript">
    var startDate = $('input[name="start_date"]');
    var endDate = $('input[name="end_date"]');
    var preselectDate = $('input[name="preselect_date"]');
    var selectResults = $('#search_results');

    preselectDate.on('change', function(){
        var selected = $(this);
        daterange.data('daterangepicker').setStartDate(selected.attr('data-startdate'));
        daterange.data('daterangepicker').setEndDate(selected.attr('data-enddate'));
        startDate.val(selected.attr('data-startdate'));
        endDate.val(selected.attr('data-enddate'));
    });

    var daterange = $('#dateRange').daterangepicker({
        startDate: startDate.val(),
        endDate: endDate.val(),
        locale: {
            format: 'DD/MM/YYYY'
        }
    }, function(start, end, label){
        preselectDate.prop("checked", false).parent().removeClass('active');
        startDate.val(start.format('DD/MM/YYYY'));
        endDate.val(end.format('DD/MM/YYYY'));
    });

    $('#dateRangeBtn').on('click', function(){
        daterange.focus();
    });

    $('form#event-filter').on('submit', function(e){
        selectResults.addClass('loading-container');
        var form = $(this);
        e.preventDefault();
        var url = form.attr('action');

        $.get(url, form.serialize(), function(data){
            selectResults.find('.results').html(data);
            selectResults.removeClass('loading-container');

            window.history.replaceState('page2', '', url + '?' + form.serialize());
        });

    });


</script>
{% endblock scripts %}